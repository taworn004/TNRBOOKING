<!DOCTYPE html>
<html lang="th">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>TNR Meeting Room Booking System</title>
  
  <link href="https://fonts.googleapis.com/css2?family=Prompt:wght@300;400;500;600;700&display=swap" rel="stylesheet">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
  <link rel="stylesheet" href="https://cdn.datatables.net/1.13.6/css/dataTables.bootstrap5.min.css">
  
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>

  <style>
    :root { 
      --primary-blue: #007bff;   
      --light-blue: #e7f1ff;     
      --vibrant-pink: #ff1493;   
      --light-pink: #ffe6f2;     
      --deep-bg: #f4f7f6;        
    }

    body { background: var(--deep-bg); font-family: 'Prompt', sans-serif; color: #2b2d42; font-size: 16px; }
    .card { border: none; border-radius: 20px; box-shadow: 0 10px 30px rgba(0,0,0,0.08); margin-bottom: 25px; }
    .bg-gradient-header { background: linear-gradient(135deg, #0056b3 0%, #007bff 100%); color: white; }
    .bg-gradient-blue { background: linear-gradient(135deg, #4facfe 0%, #00f2fe 100%); color: white; }
    .bg-gradient-pink { background: linear-gradient(135deg, #ff0844 0%, #ffb199 100%); color: white; }
    .btn-primary { background: linear-gradient(135deg, #007bff, #4facfe); border: none; border-radius: 12px; padding: 12px 25px; font-weight: 600; }
    .btn-success { background: linear-gradient(135deg, #ff1493, #ff758c); border: none; border-radius: 12px; padding: 12px 25px; font-weight: 600; }
    .btn-info { background: var(--primary-blue); border: none; color: white; }
    .form-control, .form-select { border-radius: 12px; border: 2px solid #ced4da; padding: 10px; font-size: 1rem; }
    .form-control:focus { border-color: var(--vibrant-pink); box-shadow: 0 0 0 4px rgba(255, 20, 147, 0.1); } 
    .auth-wrapper { max-width: 500px; margin: 80px auto; }
    .main-wrapper { max-width: 1400px; margin: 40px auto; display: none; }
    #calendar { background: white; padding: 30px; border-radius: 0 0 25px 25px; border: 1px solid #eee; border-top: none; }
    .calendar-header { background: linear-gradient(135deg, #0056b3, #007bff); color: white; padding: 15px 30px; border-radius: 25px 25px 0 0; font-weight: bold; font-size: 1.2rem; }
    .badge { padding: 10px 18px; border-radius: 12px; font-size: 0.9rem; }
    .stat-val { font-size: 3.5rem; font-weight: 800; }
    .table-light { background-color: var(--light-blue); color: #0056b3; }

    @media (max-width: 768px) {
      body { font-size: 14px; }
      .card { border-radius: 15px; margin-bottom: 15px; }
      .main-wrapper { margin: 15px auto; padding: 0 10px; }
      .d-flex.justify-content-between { flex-direction: column; align-items: flex-start !important; gap: 15px; }
      .text-end.d-flex { flex-direction: row; flex-wrap: wrap; justify-content: flex-start; width: 100%; }
      .btn-primary, .btn-success, .btn-outline-danger, .btn-info { padding: 8px 15px; font-size: 0.9rem; }
      .stat-val { font-size: 2.5rem; }
      #calendar { padding: 15px; }
      .calendar-header { padding: 10px 15px; font-size: 1.1rem; }
      .table-responsive { font-size: 0.85rem; }
      .auth-wrapper { margin: 40px auto; padding: 0 15px; }
      .card-body.p-5 { padding: 2rem !important; }
      .form-control, .form-select { padding: 8px; font-size: 0.9rem; }
    }
  </style>
</head>
<body>

  <div id="authSection" class="container auth-wrapper">
    <div class="card shadow-lg border-0">
      <div class="card-header bg-gradient-header text-center text-white" style="border-radius: 20px 20px 0 0;">
        <h3 class="mb-0 fw-bold"><i class="fa-solid fa-lock me-2"></i>Login/‡πÄ‡∏Ç‡πâ‡∏≤‡∏™‡∏π‡πà‡∏£‡∏∞‡∏ö‡∏ö</h3>
      </div>
      <div class="card-body p-5">
        <form id="loginForm">
          <div class="mb-4"><label class="form-label fw-bold" style="color: var(--primary-blue);">Username (‡∏´‡∏≤‡∏Å‡πÄ‡∏õ‡πá‡∏ô‡∏ú‡∏π‡πâ‡∏ö‡∏£‡∏¥‡∏´‡∏≤‡∏£‡πÉ‡∏´‡πâ‡πÉ‡∏ä‡πâ‡∏≠‡∏µ‡πÄ‡∏°‡∏•)</label><input type="text" class="form-control" id="loginUsername" required></div>
          <div class="mb-5"><label class="form-label fw-bold" style="color: var(--primary-blue);">Password</label><input type="password" class="form-control" id="loginPassword" required></div>
          <button type="submit" id="loginBtn" class="btn btn-primary w-100 py-3">‡πÄ‡∏Ç‡πâ‡∏≤‡∏™‡∏π‡πà‡∏£‡∏∞‡∏ö‡∏ö</button>
        </form>
      </div>
    </div>
  </div>

  <div id="mainSection" class="container-fluid main-wrapper">
    
    <div class="d-flex justify-content-between align-items-center mb-4 bg-white p-4 rounded-4 shadow-sm border-start border-5" style="border-color: var(--primary-blue) !important;">
      <div class="d-flex align-items-center">
        <img src="https://lh3.googleusercontent.com/d/1XreUiNnpIFxs_qraizBUdSq3RxbpeZRd" alt="TNR Logo" style="width: 50px; height: 50px; margin-right: 15px; object-fit: contain;">
        <div>
          <h2 class="mb-1 fw-bold" style="color: var(--primary-blue);">TNR Meeting Room Booking System</h2>
          <div class="text-muted"><i class="fa-solid fa-chart-line me-2"></i>Thai Nippon Rubber Industry Public Company Limited</div>
        </div>
      </div>
      <div class="text-end d-flex flex-column align-items-end gap-2">
        <div class="d-flex align-items-center gap-2 mb-1">
          <i class="fa-solid fa-user" style="color: var(--vibrant-pink);"></i>
          <span class="text-secondary fw-bold" id="welcomeName">‡∏Ñ‡∏∏‡∏ì taworn</span>
          <span class="text-muted" id="userRoleBadge">(Admin)</span>
        </div>
        <div class="d-flex gap-2">
          <button id="btnNavUsers" class="btn btn-outline-primary btn-sm rounded-pill px-4" onclick="switchView('users')" style="display:none"><i class="fa-solid fa-users-gear me-1"></i>‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£‡∏£‡∏∞‡∏ö‡∏ö</button>
          <button id="btnNavDash" class="btn btn-info btn-sm rounded-pill px-4 text-white" onclick="switchView('dashboard')" style="display:none"><i class="fa-solid fa-house me-1"></i>‡∏´‡∏ô‡πâ‡∏≤‡∏à‡∏≠‡∏á‡∏´‡πâ‡∏≠‡∏á</button>
          <button class="btn btn-outline-danger btn-sm rounded-pill px-4" onclick="logout()"><i class="fa-solid fa-power-off me-1"></i>‡∏≠‡∏≠‡∏Å‡∏à‡∏≤‡∏Å‡∏£‡∏∞‡∏ö‡∏ö</button>
        </div>
      </div>
    </div>

    <div id="dashboardView">
      <div id="approvalSection" style="display:none" class="mb-4">
        <div class="card border-0 border-start border-5 shadow-sm" style="border-color: var(--vibrant-pink) !important;">
          <div class="card-header" style="background-color: var(--light-pink); border-radius: 15px 15px 0 0;"><h5 class="mb-0 fw-bold" style="color: var(--vibrant-pink);"><i class="fa-solid fa-hourglass-half me-2"></i>‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏£‡∏≠‡∏Å‡∏≤‡∏£‡∏≠‡∏ô‡∏∏‡∏°‡∏±‡∏ï‡∏¥ (‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏Ñ‡∏∏‡∏ì)</h5></div>
          <div class="card-body"><div class="table-responsive"><table class="table align-middle w-100"><thead class="table-light"><tr><th>‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà</th><th>‡πÄ‡∏ß‡∏•‡∏≤</th><th>‡∏´‡πâ‡∏≠‡∏á</th><th>‡∏ú‡∏π‡πâ‡∏à‡∏≠‡∏á</th><th>‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£</th></tr></thead><tbody id="approvalBody"></tbody></table></div></div>
        </div>
      </div>
      
      <div class="row mb-4">
        <div class="col-md-4"><div class="card bg-gradient-blue text-center p-4 h-100 text-white shadow-sm"><h5>‡∏Å‡∏≤‡∏£‡∏à‡∏≠‡∏á‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à</h5><div class="stat-val" id="statTotal">0</div></div></div>
        <div class="col-md-8"><div class="card bg-white p-4 h-100 shadow-sm"><h5 class="fw-bold" style="color: var(--vibrant-pink);"><i class="fa-solid fa-trophy me-2"></i>‡∏´‡πâ‡∏≠‡∏á‡∏õ‡∏£‡∏∞‡∏ä‡∏∏‡∏°‡∏¢‡∏≠‡∏î‡∏Æ‡∏¥‡∏ï 3 ‡∏≠‡∏±‡∏ô‡∏î‡∏±‡∏ö‡πÅ‡∏£‡∏Å</h5><div class="row text-center mt-3" id="statTopRooms"></div></div></div>
      </div>

      <div class="card mb-4 border-0 shadow-sm border-top border-5 bg-white" style="border-color: var(--primary-blue) !important;">
        <div class="card-body p-4">
          <h5 class="fw-bold mb-4 border-bottom pb-2" style="color: var(--primary-blue);"><i class="fa-solid fa-book-open-reader me-2"></i>‡∏£‡∏∞‡πÄ‡∏ö‡∏µ‡∏¢‡∏ö‡∏Ç‡∏±‡πâ‡∏ô‡∏ï‡∏≠‡∏ô‡∏Å‡∏≤‡∏£‡∏Ç‡∏≠‡πÉ‡∏ä‡πâ‡∏´‡πâ‡∏≠‡∏á‡∏õ‡∏£‡∏∞‡∏ä‡∏∏‡∏°</h5>
          <div class="row text-secondary">
            <div class="col-md-4 mb-3 mb-md-0"><h6 class="fw-bold mb-2" style="color: var(--vibrant-pink);"><i class="fa-solid fa-calendar-check me-2"></i>1. ‡∏Å‡∏≤‡∏£‡∏à‡∏≠‡∏á‡πÅ‡∏•‡∏∞‡∏¢‡∏Å‡πÄ‡∏•‡∏¥‡∏Å</h6><ul class="small ps-3 mb-0" style="line-height: 1.6;"><li><b>‡∏à‡∏≠‡∏á‡∏•‡πà‡∏ß‡∏á‡∏´‡∏ô‡πâ‡∏≤:</b> ‡∏ú‡πà‡∏≤‡∏ô‡∏£‡∏∞‡∏ö‡∏ö 1-3 ‡∏ß‡∏±‡∏ô‡∏ó‡∏≥‡∏Å‡∏≤‡∏£</li><li><b>‡∏¢‡∏Å‡πÄ‡∏•‡∏¥‡∏Å:</b> ‡∏´‡∏≤‡∏Å‡πÑ‡∏°‡πà‡πÉ‡∏ä‡πâ‡∏ï‡πâ‡∏≠‡∏á‡πÅ‡∏à‡πâ‡∏á‡∏ó‡∏±‡∏ô‡∏ó‡∏µ</li><li><b>‡∏™‡πà‡∏ß‡∏ô‡∏Å‡∏•‡∏≤‡∏á:</b> ‡∏≠‡∏≤‡∏à‡∏Ç‡∏≠‡∏¢‡∏Å‡πÄ‡∏•‡∏¥‡∏Å‡πÑ‡∏î‡πâ‡∏´‡∏≤‡∏Å‡∏°‡∏µ‡πÄ‡∏´‡∏ï‡∏∏‡πÄ‡∏£‡πà‡∏á‡∏î‡πà‡∏ß‡∏ô</li></ul></div>
            <div class="col-md-4 mb-3 mb-md-0 border-start border-light border-2"><h6 class="fw-bold text-primary mb-2"><i class="fa-solid fa-users me-2"></i>2. ‡∏°‡∏≤‡∏£‡∏¢‡∏≤‡∏ó‡πÅ‡∏•‡∏∞‡∏Ç‡πâ‡∏≠‡∏õ‡∏è‡∏¥‡∏ö‡∏±‡∏ï‡∏¥</h6><ul class="small ps-3 mb-0" style="line-height: 1.6;"><li><b>‡πÄ‡∏ß‡∏•‡∏≤:</b> ‡πÄ‡∏Ç‡πâ‡∏≤‡πÅ‡∏•‡∏∞‡πÄ‡∏•‡∏¥‡∏Å‡πÉ‡∏´‡πâ‡∏ï‡∏£‡∏á‡πÄ‡∏ß‡∏•‡∏≤</li><li><b>‡∏™‡∏∑‡πà‡∏≠‡∏™‡∏≤‡∏£:</b> ‡∏õ‡∏¥‡∏î‡πÄ‡∏™‡∏µ‡∏¢‡∏á‡∏°‡∏∑‡∏≠‡∏ñ‡∏∑‡∏≠</li><li><b>‡∏≠‡∏≤‡∏´‡∏≤‡∏£:</b> ‡∏á‡∏î‡∏≠‡∏≤‡∏´‡∏≤‡∏£‡∏Å‡∏•‡∏¥‡πà‡∏ô‡πÅ‡∏£‡∏á</li><li><b>‡∏ó‡∏£‡∏±‡∏û‡∏¢‡πå‡∏™‡∏¥‡∏ô:</b> ‡∏´‡πâ‡∏≤‡∏°‡∏¢‡πâ‡∏≤‡∏¢‡∏≠‡∏∏‡∏õ‡∏Å‡∏£‡∏ì‡πå‡∏û‡∏•‡∏∞‡∏Å‡∏≤‡∏£</li></ul></div>
            <div class="col-md-4 border-start border-light border-2"><h6 class="fw-bold text-danger mb-2"><i class="fa-solid fa-broom me-2"></i>3. ‡∏´‡∏•‡∏±‡∏á‡∏Å‡∏≤‡∏£‡πÉ‡∏ä‡πâ‡∏á‡∏≤‡∏ô</h6><ul class="small ps-3 mb-0" style="line-height: 1.6;"><li><b>‡∏ó‡∏≥‡∏Ñ‡∏ß‡∏≤‡∏°‡∏™‡∏∞‡∏≠‡∏≤‡∏î:</b> ‡∏à‡∏±‡∏î‡πÇ‡∏ï‡πä‡∏∞‡πÅ‡∏•‡∏∞‡∏ó‡∏¥‡πâ‡∏á‡∏Ç‡∏¢‡∏∞</li><li><b>‡∏õ‡∏£‡∏∞‡∏´‡∏¢‡∏±‡∏î‡πÑ‡∏ü:</b> ‡∏õ‡∏¥‡∏î‡πÅ‡∏≠‡∏£‡πå ‡πÑ‡∏ü ‡∏ó‡∏∏‡∏Å‡∏Ñ‡∏£‡∏±‡πâ‡∏á</li><li><b>‡∏ä‡∏≥‡∏£‡∏∏‡∏î:</b> ‡πÅ‡∏à‡πâ‡∏á‡∏ó‡∏±‡∏ô‡∏ó‡∏µ‡∏´‡∏≤‡∏Å‡∏û‡∏ö‡∏Ñ‡∏ß‡∏≤‡∏°‡πÄ‡∏™‡∏µ‡∏¢‡∏´‡∏≤‡∏¢</li></ul></div>
          </div>
        </div>
      </div>

      <div class="card mb-4 border-0 shadow-sm">
        <div class="calendar-header"><i class="fa-solid fa-calendar-days me-2"></i>‡∏õ‡∏è‡∏¥‡∏ó‡∏¥‡∏ô‡∏Å‡∏≤‡∏£‡∏à‡∏≠‡∏á‡∏´‡πâ‡∏≠‡∏á‡∏õ‡∏£‡∏∞‡∏ä‡∏∏‡∏°</div>
        <div id="calendar"></div>
      </div>

      <div class="row">
        <div class="col-lg-4">
          <div class="card p-4 border-top border-5 shadow-sm" style="border-color: var(--vibrant-pink) !important;">
            
            <div class="text-center mb-4 border-bottom pb-3">
              <img src="https://lh3.googleusercontent.com/d/1XreUiNnpIFxs_qraizBUdSq3RxbpeZRd" alt="TNR Logo" style="width: 60px; height: 60px; object-fit: contain; margin-bottom: 10px;">
              <h4 class="fw-bold mb-0" style="color: var(--vibrant-pink);">‡πÅ‡∏ö‡∏ö‡∏ü‡∏≠‡∏£‡πå‡∏°‡∏Å‡∏≤‡∏£‡∏à‡∏≠‡∏á‡∏´‡πâ‡∏≠‡∏á‡∏õ‡∏£‡∏∞‡∏ä‡∏∏‡∏°</h4>
              <small class="text-muted">Thai Nippon Rubber Industry PCL.</small>
            </div>

            <form id="bookingForm">
              <div class="mb-3"><label class="form-label fw-bold text-dark">1. ‡∏´‡∏±‡∏ß‡∏Ç‡πâ‡∏≠‡∏Å‡∏≤‡∏£‡∏õ‡∏£‡∏∞‡∏ä‡∏∏‡∏°</label><input type="text" id="bookTitle" class="form-control" required></div>
              <div class="row g-2 mb-3"><div class="col-6"><label class="form-label fw-bold text-secondary small">‡πÅ‡∏ú‡∏ô‡∏Å</label><input type="text" id="bookDept" class="form-control" required></div><div class="col-6"><label class="form-label fw-bold text-secondary small">‡πÇ‡∏ó‡∏£‡∏®‡∏±‡∏û‡∏ó‡πå‡∏ï‡∏¥‡∏î‡∏ï‡πà‡∏≠</label><input type="text" id="bookPhone" class="form-control" required></div></div>
              <div class="row g-2 mb-3"><div class="col-6"><label class="form-label fw-bold text-secondary small">‡∏õ‡∏£‡∏∞‡πÄ‡∏†‡∏ó‡∏Å‡∏¥‡∏à‡∏Å‡∏£‡∏£‡∏°</label><select id="bookActivityType" class="form-select" required><option>‡∏õ‡∏£‡∏∞‡∏ä‡∏∏‡∏°</option><option>‡∏™‡∏±‡∏°‡∏°‡∏ô‡∏≤</option><option>‡∏≠‡∏ö‡∏£‡∏°</option><option>‡∏ö‡∏£‡∏£‡∏¢‡∏≤‡∏¢</option><option>‡∏£‡∏±‡∏ö‡∏£‡∏≠‡∏á‡πÅ‡∏Ç‡∏Å</option><option>‡∏≠‡∏∑‡πà‡∏ô‡πÜ</option></select></div><div class="col-6"><label class="form-label fw-bold text-secondary small">‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡∏ú‡∏π‡πâ‡πÄ‡∏Ç‡πâ‡∏≤‡∏õ‡∏£‡∏∞‡∏ä‡∏∏‡∏°</label><input type="number" id="bookHeadcount" class="form-control" min="1" required></div></div>
              <div class="mb-3 p-3 rounded border" style="background-color: var(--light-blue); border-color: var(--primary-blue) !important;"><label class="form-label fw-bold mb-1" style="color: var(--primary-blue);"><i class="fa-solid fa-envelope-circle-check me-2"></i>‡∏≠‡∏µ‡πÄ‡∏°‡∏•‡∏ú‡∏π‡πâ‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£‡πÅ‡∏ú‡∏ô‡∏Å (‡∏ú‡∏π‡πâ‡∏≠‡∏ô‡∏∏‡∏°‡∏±‡∏ï‡∏¥‡∏Ç‡∏±‡πâ‡∏ô‡∏ó‡∏µ‡πà 1)</label><input type="email" id="bookManagerEmail" class="form-control" style="border-color: var(--primary-blue);" placeholder="‡∏≠‡∏µ‡πÄ‡∏°‡∏•‡∏´‡∏±‡∏ß‡∏´‡∏ô‡πâ‡∏≤‡∏á‡∏≤‡∏ô‡∏Ç‡∏≠‡∏á‡∏Ñ‡∏∏‡∏ì" required><small class="text-muted mt-1 d-block">‡∏£‡∏∞‡∏ö‡∏ö‡∏à‡∏∞‡∏™‡πà‡∏á‡πÅ‡∏à‡πâ‡∏á‡πÄ‡∏ï‡∏∑‡∏≠‡∏ô‡πÑ‡∏õ‡πÉ‡∏´‡πâ‡∏´‡∏±‡∏ß‡∏´‡∏ô‡πâ‡∏≤‡πÅ‡∏ú‡∏ô‡∏Å‡∏≠‡∏ô‡∏∏‡∏°‡∏±‡∏ï‡∏¥</small></div>
              <hr class="my-4">
              <div class="mb-3"><label class="form-label fw-bold text-dark">2. ‡∏ß‡∏±‡∏ô‡πÅ‡∏•‡∏∞‡πÄ‡∏ß‡∏•‡∏≤</label></div>
              <div class="row g-2 mb-3"><div class="col-6"><label class="form-label text-secondary small">‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà</label><input type="date" id="bookStartDate" class="form-control" required></div><div class="col-6"><label class="form-label text-secondary small">‡∏ñ‡∏∂‡∏á‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà</label><input type="date" id="bookEndDate" class="form-control" required></div></div>
              <div class="row g-2 mb-3"><div class="col-6"><label class="form-label text-secondary small">‡πÄ‡∏ß‡∏•‡∏≤‡πÄ‡∏£‡∏¥‡πà‡∏°</label><input type="time" id="bookStartTime" class="form-control" required></div><div class="col-6"><label class="form-label text-secondary small">‡πÄ‡∏ß‡∏•‡∏≤‡∏™‡∏¥‡πâ‡∏ô‡∏™‡∏∏‡∏î</label><input type="time" id="bookEndTime" class="form-control" required></div></div>
              <hr class="my-4"><div class="mb-3"><label class="form-label fw-bold text-dark">3. ‡∏´‡πâ‡∏≠‡∏á‡∏õ‡∏£‡∏∞‡∏ä‡∏∏‡∏°</label><select id="bookRoom" class="form-select" required></select></div><hr class="my-4">
              <div class="mb-3"><label class="form-label fw-bold text-dark">4. ‡∏≠‡∏∏‡∏õ‡∏Å‡∏£‡∏ì‡πå‡∏ó‡∏µ‡πà‡∏Ç‡∏≠‡πÉ‡∏ä‡πâ</label><div class="row mt-2 text-secondary"><div class="col-6 mb-2"><div class="form-check"><input class="form-check-input" type="checkbox" name="bookEquip" value="‡πÑ‡∏°‡πÇ‡∏Ñ‡∏£‡πÇ‡∏ü‡∏ô" id="eq1"><label class="form-check-label" for="eq1">‡πÑ‡∏°‡πÇ‡∏Ñ‡∏£‡πÇ‡∏ü‡∏ô</label></div></div><div class="col-6 mb-2"><div class="form-check"><input class="form-check-input" type="checkbox" name="bookEquip" value="‡∏Ñ‡∏≠‡∏°‡∏û‡∏¥‡∏ß‡πÄ‡∏ï‡∏≠‡∏£‡πå" id="eq2"><label class="form-check-label" for="eq2">‡∏Ñ‡∏≠‡∏°‡∏û‡∏¥‡∏ß‡πÄ‡∏ï‡∏≠‡∏£‡πå</label></div></div><div class="col-6 mb-2"><div class="form-check"><input class="form-check-input" type="checkbox" name="bookEquip" value="LCD Projector" id="eq3"><label class="form-check-label" for="eq3">LCD Projector</label></div></div><div class="col-6 mb-2"><div class="form-check"><input class="form-check-input" type="checkbox" name="bookEquip" value="Video Conference" id="eq4"><label class="form-check-label" for="eq4">Video Conf.</label></div></div><div class="col-12"><div class="form-check"><input class="form-check-input" type="checkbox" name="bookEquip" value="‡∏ä‡∏∏‡∏î‡∏Å‡∏≤‡∏ß‡∏ô‡πå‡∏£‡∏±‡∏ö‡∏£‡∏≠‡∏á‡πÅ‡∏Ç‡∏Å" id="eq5"><label class="form-check-label" for="eq5">‡∏ä‡∏∏‡∏î‡∏Å‡∏≤‡∏ß‡∏ô‡πå‡∏£‡∏±‡∏ö‡∏£‡∏≠‡∏á‡πÅ‡∏Ç‡∏Å</label></div></div></div></div>
              <hr class="my-4"><div class="mb-3"><label class="form-label fw-bold text-dark">‡∏£‡∏≤‡∏¢‡∏•‡∏∞‡πÄ‡∏≠‡∏µ‡∏¢‡∏î‡πÄ‡∏û‡∏¥‡πà‡∏°‡πÄ‡∏ï‡∏¥‡∏° (‡∏ñ‡πâ‡∏≤‡∏°‡∏µ)</label><textarea id="bookDesc" class="form-control" rows="2"></textarea></div><div class="mb-3"><label class="form-label fw-bold text-secondary small">‡∏≠‡∏µ‡πÄ‡∏°‡∏•‡∏ú‡∏π‡πâ‡πÄ‡∏Ç‡πâ‡∏≤‡∏£‡πà‡∏ß‡∏° (‡∏™‡πà‡∏á Calendar Invite)</label><input type="text" id="bookAttendees" class="form-control" placeholder="user@tnr.co.th, ..."></div><div class="mb-4"><label class="form-label fw-bold text-danger small">‡πÅ‡∏ô‡∏ö‡πÄ‡∏≠‡∏Å‡∏™‡∏≤‡∏£ (‡∏ñ‡πâ‡∏≤‡∏°‡∏µ)</label><input type="file" id="bookFile" class="form-control"></div>
              <button type="submit" id="submitBookingBtn" class="btn btn-success w-100 py-3 fw-bold fs-5 shadow-sm"><i class="fa-solid fa-paper-plane me-2"></i>‡∏™‡πà‡∏á‡∏Ñ‡∏≥‡∏Ç‡∏≠‡∏à‡∏≠‡∏á‡∏´‡πâ‡∏≠‡∏á</button>
            </form>
          </div>
        </div>
        
        <div class="col-lg-8"><div class="card p-4 shadow-sm border-top border-5" style="border-color: var(--primary-blue) !important;"><h4 class="mb-4 fw-bold" style="color: var(--primary-blue);"><i class="fa-solid fa-clock-rotate-left me-2"></i>‡∏õ‡∏£‡∏∞‡∏ß‡∏±‡∏ï‡∏¥‡∏Å‡∏≤‡∏£‡∏à‡∏≠‡∏á‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î</h4><div class="table-responsive"><table id="bookingTable" class="table table-hover w-100"><thead class="table-light"><tr><th>‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà</th><th>‡πÄ‡∏ß‡∏•‡∏≤</th><th>‡∏´‡πâ‡∏≠‡∏á</th><th>‡∏ú‡∏π‡πâ‡∏à‡∏≠‡∏á</th><th>‡πÑ‡∏ü‡∏•‡πå</th><th>‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞</th><th>‡∏•‡∏ö</th></tr></thead><tbody></tbody></table></div></div></div>
      </div>
    </div>

    <div id="usersView" style="display:none">
      <ul class="nav nav-pills mb-4 gap-2 flex-wrap">
        <li class="nav-item"><button class="nav-link active rounded-pill px-4 fw-bold shadow-sm" data-bs-toggle="pill" data-bs-target="#p-rooms" style="background-color: var(--primary-blue);">‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£‡∏´‡πâ‡∏≠‡∏á‡∏õ‡∏£‡∏∞‡∏ä‡∏∏‡∏°</button></li>
        <li class="nav-item"><button class="nav-link rounded-pill px-4 fw-bold shadow-sm" data-bs-toggle="pill" data-bs-target="#p-users" style="color: var(--primary-blue);">‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£‡∏ú‡∏π‡πâ‡πÉ‡∏ä‡πâ‡∏á‡∏≤‡∏ô</button></li>
        <li class="nav-item"><button class="nav-link rounded-pill px-4 fw-bold shadow-sm border" data-bs-toggle="pill" data-bs-target="#p-admin-app" style="color: var(--vibrant-pink); border-color: var(--vibrant-pink) !important;">ADMIN PASS</button></li>
      </ul>
      <div class="tab-content mt-4">
        <div class="tab-pane fade show active" id="p-rooms"><div class="card p-4 border-top border-5 shadow-sm" style="border-color: var(--primary-blue) !important;"><div class="d-flex justify-content-between mb-4 flex-wrap gap-2"><h5 style="color: var(--primary-blue); font-weight: bold;">‡∏£‡∏≤‡∏¢‡∏ä‡∏∑‡πà‡∏≠‡∏´‡πâ‡∏≠‡∏á‡∏õ‡∏£‡∏∞‡∏ä‡∏∏‡∏°</h5><button class="btn btn-primary btn-sm px-4" onclick="openRoomModal()">+ ‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏´‡πâ‡∏≠‡∏á</button></div><div class="table-responsive"><table id="roomTable" class="table w-100"><thead><tr><th>ID</th><th>‡∏ä‡∏∑‡πà‡∏≠‡∏´‡πâ‡∏≠‡∏á</th><th>‡∏£‡∏≤‡∏¢‡∏•‡∏∞‡πÄ‡∏≠‡∏µ‡∏¢‡∏î</th><th>‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£</th></tr></thead><tbody></tbody></table></div></div></div>
        <div class="tab-pane fade" id="p-users"><div class="card p-4 shadow-sm border-top border-5" style="border-color: var(--primary-blue) !important;"><h5 style="color: var(--primary-blue); font-weight: bold;">‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£‡∏ú‡∏π‡πâ‡πÉ‡∏ä‡πâ‡∏á‡∏≤‡∏ô</h5><button class="btn btn-primary btn-sm mb-4" onclick="openUserModal()">+ ‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏ú‡∏π‡πâ‡πÉ‡∏ä‡πâ</button><div class="table-responsive"><table id="userTable" class="table w-100"><thead><tr><th>ID</th><th>‡∏ä‡∏∑‡πà‡∏≠</th><th>Username</th><th>Role</th><th>‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£</th></tr></thead><tbody></tbody></table></div></div></div>
        <div class="tab-pane fade" id="p-admin-app"><div class="card p-4 shadow-sm border-top border-5" style="border-color: var(--vibrant-pink) !important;"><h5 style="color: var(--vibrant-pink); font-weight: bold;">Admin Override</h5><div class="table-responsive"><table id="adminAppTable" class="table w-100"><thead><tr><th>‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà</th><th>‡πÄ‡∏ß‡∏•‡∏≤</th><th>‡∏´‡πâ‡∏≠‡∏á</th><th>‡∏ú‡∏π‡πâ‡∏à‡∏≠‡∏á</th><th>‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞</th><th>‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£</th></tr></thead><tbody></tbody></table></div></div></div>
      </div>
    </div>
  </div>

  <div class="text-center mt-5 mb-5 text-muted small">&copy; 2026 TAWORN SINGSANAN. All rights reserved.</div>

  <script src="https://code.jquery.com/jquery-3.7.0.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
  <script src="https://cdn.datatables.net/1.13.6/js/jquery.dataTables.min.js"></script>
  <script src="https://cdn.datatables.net/1.13.6/js/dataTables.bootstrap5.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
  <script src='https://cdn.jsdelivr.net/npm/fullcalendar@6.1.15/index.global.min.js'></script>

  <script>
    let calendar;
    let allBookingsData = [];
    let globalSignatures = {}; // üü¢ ‡πÄ‡∏Å‡πá‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏•‡∏≤‡∏¢‡πÄ‡∏ã‡πá‡∏ô‡πÑ‡∏ß‡πâ‡πÅ‡∏ö‡∏ö Global

    window.onload = () => { 
      const u = sessionStorage.getItem("activeUser"); 
      if(u) { 
        showDashboard(JSON.parse(u)); 
      } else { 
        $('#mainSection').hide(); $('#authSection').show(); 
      } 
    };

    // üü¢ ‡∏î‡∏∂‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏•‡∏≤‡∏¢‡πÄ‡∏ã‡πá‡∏ô‡∏°‡∏≤‡πÄ‡∏ï‡∏£‡∏µ‡∏¢‡∏°‡πÑ‡∏ß‡πâ
    function fetchSignatures() {
      google.script.run.withSuccessHandler(res => {
        globalSignatures = res;
      }).getSignatures();
    }

    function logout() { 
      Swal.fire({ icon: 'success', title: '‡∏≠‡∏≠‡∏Å‡∏à‡∏≤‡∏Å‡∏£‡∏∞‡∏ö‡∏ö‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à', showConfirmButton: false, timer: 1200 }).then(() => { 
        sessionStorage.removeItem("activeUser"); 
        if(calendar) { calendar.destroy(); calendar = null; }
        if($.fn.DataTable.isDataTable('#bookingTable')) { $('#bookingTable').DataTable().clear().destroy(); $('#bookingTable tbody').empty(); }
        $('#mainSection').hide(); $('#dashboardView').hide(); $('#usersView').hide(); $('#authSection').fadeIn(); 
        $('#loginForm').show(); $('#registerForm').hide(); $('#loginForm')[0].reset();
      });
    }

    $('#loginForm').on('submit', function(e) {
      e.preventDefault(); const btn = $('#loginBtn'); btn.prop('disabled', true).text('Checking...');
      google.script.run.withSuccessHandler(res => {
        btn.prop('disabled', false).text('‡πÄ‡∏Ç‡πâ‡∏≤‡∏™‡∏π‡πà‡∏£‡∏∞‡∏ö‡∏ö');
        if(res.success) { sessionStorage.setItem("activeUser", JSON.stringify(res.userData)); showDashboard(res.userData); }
        else Swal.fire('Error', res.message, 'error');
      }).loginUser({ loginUsername: $('#loginUsername').val(), loginPassword: $('#loginPassword').val() });
    });

    function showDashboard(u) {
      $('#authSection').hide(); $('#mainSection').fadeIn();
      $('#welcomeName').text(`‡∏Ñ‡∏∏‡∏ì ${u.name}`); $('#userRoleBadge').text(`(${u.role})`);
      if(u.role === 'Admin') $('#btnNavUsers').show();
      loadRoomsToSelect(); 
      fetchSignatures(); // ‡πÇ‡∏´‡∏•‡∏î‡∏•‡∏≤‡∏¢‡πÄ‡∏ã‡πá‡∏ô‡πÄ‡∏ï‡∏£‡∏µ‡∏¢‡∏°‡πÑ‡∏ß‡πâ‡πÄ‡∏•‡∏¢
      switchView('dashboard');
    }

    function switchView(v) { 
      const u = JSON.parse(sessionStorage.getItem("activeUser"));
      if(v === 'users') {
        if(!u || u.role !== 'Admin') return;
        $('#dashboardView').hide(); $('#usersView').fadeIn(); $('#btnNavUsers').hide(); $('#btnNavDash').show(); 
        loadUserTable(); loadAdminAppTable(); loadRoomsTable();
      } else { 
        $('#usersView').hide(); $('#dashboardView').fadeIn(); $('#btnNavDash').hide(); 
        if(u && u.role==='Admin') $('#btnNavUsers').show(); 
        loadTableData(); setTimeout(renderCalendar, 200); 
      } 
    }

    function loadRoomsToSelect() { google.script.run.withSuccessHandler(rooms => { let opt = "<option value='' disabled selected>-- ‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏´‡πâ‡∏≠‡∏á‡∏õ‡∏£‡∏∞‡∏ä‡∏∏‡∏° --</option>"; rooms.forEach(r => { opt += `<option value="${r[1]}">${r[1]} (${r[2]})</option>`; }); $('#bookRoom').html(opt); }).getRoomsList(); }
    function loadRoomsTable() { google.script.run.withSuccessHandler(rooms => { const rows = rooms.map(r => [r[0], r[1], r[2], `<button class="btn btn-sm btn-outline-primary me-1" onclick="openRoomModal('${r[0]}','${r[1]}','${r[2]}')">‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç</button><button class="btn btn-sm btn-outline-danger" onclick="deleteRoom('${r[0]}')">‡∏•‡∏ö</button>`]); if($.fn.DataTable.isDataTable('#roomTable')) $('#roomTable').DataTable().destroy(); $('#roomTable').DataTable({ data: rows }); }).getRoomsList(); }
    function openRoomModal(id='', name='', desc='') { Swal.fire({ title: id ? '‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç‡∏´‡πâ‡∏≠‡∏á' : '‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏´‡πâ‡∏≠‡∏á‡πÉ‡∏´‡∏°‡πà', html: `<input id="r_name" class="form-control mb-3" placeholder="‡∏ä‡∏∑‡πà‡∏≠‡∏´‡πâ‡∏≠‡∏á" value="${name}"><input id="r_desc" class="form-control" placeholder="‡∏£‡∏≤‡∏¢‡∏•‡∏∞‡πÄ‡∏≠‡∏µ‡∏¢‡∏î" value="${desc}">`, showCancelButton: true, confirmButtonText: '‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å', preConfirm: () => ({ id: id, name: $('#r_name').val(), desc: $('#r_desc').val() }) }).then(res => { if(res.isConfirmed) google.script.run.withSuccessHandler(() => { loadRoomsTable(); loadRoomsToSelect(); }).saveRoom(res.value); }); }
    function deleteRoom(id) { Swal.fire({ title: '‡∏•‡∏ö‡∏´‡πâ‡∏≠‡∏á?', icon: 'warning', showCancelButton: true }).then(r => { if(r.isConfirmed) google.script.run.withSuccessHandler(() => { loadRoomsTable(); loadRoomsToSelect(); }).deleteRoom(id); }); }

    // üü¢ ‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡πÇ‡∏´‡∏•‡∏î‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ï‡∏≤‡∏£‡∏≤‡∏á + ‡∏Ñ‡∏≥‡∏ô‡∏ß‡∏ì Top 3 (‡πÄ‡∏â‡∏û‡∏≤‡∏∞‡πÄ‡∏î‡∏∑‡∏≠‡∏ô‡∏õ‡∏±‡∏à‡∏à‡∏∏‡∏ö‡∏±‡∏ô)
    function loadTableData() {
      google.script.run.withSuccessHandler(data => {
        allBookingsData = data; 
        const u = JSON.parse(sessionStorage.getItem("activeUser")); 
        
        let conf = 0; 
        let rooms = {}; // ‡∏ï‡∏±‡∏ß‡πÅ‡∏õ‡∏£‡πÄ‡∏Å‡πá‡∏ö‡∏Ñ‡∏∞‡πÅ‡∏ô‡∏ô‡∏´‡πâ‡∏≠‡∏á (‡πÄ‡∏â‡∏û‡∏≤‡∏∞‡πÄ‡∏î‡∏∑‡∏≠‡∏ô‡∏ô‡∏µ‡πâ)
        
        // üü¢ ‡∏î‡∏∂‡∏á‡πÄ‡∏î‡∏∑‡∏≠‡∏ô‡πÅ‡∏•‡∏∞‡∏õ‡∏µ‡∏õ‡∏±‡∏à‡∏à‡∏∏‡∏ö‡∏±‡∏ô ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡πÄ‡∏≠‡∏≤‡∏°‡∏≤‡πÄ‡∏ó‡∏µ‡∏¢‡∏ö
        const now = new Date();
        const thisMonth = now.getMonth();
        const thisYear = now.getFullYear();

        const rows = data.map(r => {
          // r[9] = Status, r[3] = Date (yyyy-MM-dd)
          if(r[9]==='Confirmed') { 
            conf++; // ‡∏¢‡∏≠‡∏î‡∏à‡∏≠‡∏á‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à‡∏£‡∏ß‡∏° (All Time)
            
            // üü¢ ‡πÄ‡∏û‡∏¥‡πà‡∏°‡πÄ‡∏á‡∏∑‡πà‡∏≠‡∏ô‡πÑ‡∏Ç: ‡∏ï‡πâ‡∏≠‡∏á‡πÄ‡∏õ‡πá‡∏ô‡πÄ‡∏î‡∏∑‡∏≠‡∏ô‡∏ô‡∏µ‡πâ‡πÅ‡∏•‡∏∞‡∏õ‡∏µ‡∏ô‡∏µ‡πâ‡πÄ‡∏ó‡πà‡∏≤‡∏ô‡∏±‡πâ‡∏ô ‡∏ñ‡∏∂‡∏á‡∏à‡∏∞‡∏ô‡∏±‡∏ö‡∏•‡∏á Top 3
            let bDate = new Date(r[3]);
            if (bDate.getMonth() === thisMonth && bDate.getFullYear() === thisYear) {
                rooms[r[2]] = (rooms[r[2]]||0)+1; 
            }
          }

          let managerEmail = r[13]; let hasAccess = false;
          if (r[6] === u.name || (u.role === 'DeptManager' && managerEmail === u.username) || ['Admin', 'HRManager'].includes(u.role)) hasAccess = true; 

          let fileBtn = r[8] ? (hasAccess ? `<a href="${r[8]}" target="_blank" class="text-info"><i class="fa-solid fa-file-pdf fs-5"></i></a>` : `<i class="fa-solid fa-lock fs-6 text-muted"></i>`) : '-';
          let delBtn = r[6]===u.name ? `<button class="btn btn-sm btn-link text-danger" onclick="cancelB('${r[0]}')"><i class="fa-solid fa-trash"></i></button>` : '-';
          
          let statusBadge = `<span class="badge ${r[9]==='Confirmed'?'bg-success':(r[9].includes('Pending')?'bg-warning':'bg-danger')}">${r[9]}</span>`;
          if(r[9]==='Confirmed' && r[6] === u.name) {
            statusBadge += ` <button class="btn btn-sm btn-outline-secondary ms-1 py-0 px-1" onclick="generatePDF('${r[0]}')" title="‡πÄ‡∏≠‡∏Å‡∏™‡∏≤‡∏£‡∏Å‡∏≤‡∏£‡∏à‡∏≠‡∏á (PDF)"><i class="fa-solid fa-print"></i></button>`;
          }

          return [r[3], `${r[4]}-${r[5]}`, r[2], r[6], fileBtn, statusBadge, delBtn];
        });
        
        $('#statTotal').text(conf); 
        updateTop(rooms); // ‡∏™‡πà‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÄ‡∏â‡∏û‡∏≤‡∏∞‡πÄ‡∏î‡∏∑‡∏≠‡∏ô‡∏ô‡∏µ‡πâ‡πÑ‡∏õ‡πÅ‡∏™‡∏î‡∏á‡∏ú‡∏•
        
        if($.fn.DataTable.isDataTable('#bookingTable')) $('#bookingTable').DataTable().destroy();
        $('#bookingTable').DataTable({ data: rows, order: [[0,'desc']], language: { url: '//cdn.datatables.net/plug-ins/1.13.6/i18n/th.json' } });
        if(['Admin','DeptManager','HRManager'].includes(u.role)) loadApproval(u.role, u.username);
      }).getBookingsList();
    }

    function renderCalendar() {
      let el = document.getElementById('calendar');
      if (!calendar) {
        calendar = new FullCalendar.Calendar(el, { 
          initialView: 'dayGridMonth', locale: 'th', height: $(window).width() < 768 ? 500 : 700, 
          headerToolbar: { left: 'prev,next', center: 'title', right: 'today' }, 
          events: (i, s) => google.script.run.withSuccessHandler(d => s(d)).getCalendarEvents(),
          eventClick: i => { 
            let start = i.event.start; let end = i.event.end;
            let dateStr = start.toLocaleDateString('th-TH', { year: 'numeric', month: 'long', day: 'numeric' });
            let timeStr = `${start.toLocaleTimeString('th-TH', {hour:'2-digit', minute:'2-digit'})} - ${end ? end.toLocaleTimeString('th-TH', {hour:'2-digit', minute:'2-digit'}) : '-'}`;
            let fullDesc = i.event.extendedProps.desc || '-';
            
            const currentUser = JSON.parse(sessionStorage.getItem("activeUser"));
            let targetRow = allBookingsData.find(r => r[11] === i.event.title && r[6] === i.event.extendedProps.booker);
            
            let pdfBtn = (targetRow && targetRow[9] === 'Confirmed' && targetRow[6] === currentUser.name) ? `<button class="btn btn-outline-primary mt-3 w-100" onclick="generatePDF('${targetRow[0]}')"><i class="fa-solid fa-file-pdf me-2"></i>‡∏î‡∏≤‡∏ß‡∏ô‡πå‡πÇ‡∏´‡∏•‡∏î‡πÄ‡∏≠‡∏Å‡∏™‡∏≤‡∏£ (PDF)</button>` : '';

            Swal.fire({
              title: '<i class="fa-solid fa-calendar-check text-info me-2"></i>‡∏£‡∏≤‡∏¢‡∏•‡∏∞‡πÄ‡∏≠‡∏µ‡∏¢‡∏î‡∏Ñ‡∏¥‡∏ß‡∏à‡∏≠‡∏á',
              html: `<div style="text-align:left; padding:15px; background:#f8f9fa; border-radius:15px; border-left:6px solid #ef233c;"><p class="mb-2 text-dark fw-bold">üìå ${i.event.title}</p><p class="mb-1 small"><b>üìÖ ‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà:</b> ${dateStr}</p><p class="mb-1 small"><b>‚è∞ ‡πÄ‡∏ß‡∏•‡∏≤:</b> ${timeStr} ‡∏ô.</p><p class="mb-1 small"><b>üè¢ ‡∏´‡πâ‡∏≠‡∏á:</b> <span class="text-primary fw-bold">${i.event.extendedProps.room}</span></p><p class="mb-1 small"><b>üë§ ‡∏ú‡∏π‡πâ‡∏à‡∏≠‡∏á:</b> ${i.event.extendedProps.booker}</p><hr class="my-2 border-secondary"><div class="p-2 bg-white rounded shadow-sm border border-light"><p class="mb-1 text-primary fw-bold small"><i class="fa-solid fa-list-ul me-1"></i> ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÄ‡∏û‡∏¥‡πà‡∏°‡πÄ‡∏ï‡∏¥‡∏°</p><div style="white-space: pre-wrap; font-size: 0.85rem; line-height: 1.5; color: #495057;">${fullDesc}</div></div>${pdfBtn}</div>`,
              showConfirmButton: false, showCloseButton: true
            }); 
          } 
        }); calendar.render();
      } else calendar.refetchEvents();
    }

    // üü¢ ‡∏™‡∏£‡πâ‡∏≤‡∏á PDF ‡πÇ‡∏î‡∏¢‡∏î‡∏∂‡∏á‡∏•‡∏≤‡∏¢‡πÄ‡∏ã‡πá‡∏ô‡∏à‡∏≤‡∏Å‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏£‡∏∞‡∏ö‡∏ö
    function generatePDF(bookingId) {
      let data = allBookingsData.find(r => r[0] === bookingId);
      if(!data) return;

      Swal.fire({ title: '‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏™‡∏£‡πâ‡∏≤‡∏á‡πÄ‡∏≠‡∏Å‡∏™‡∏≤‡∏£ PDF...', didOpen: () => Swal.showLoading() });

      let safeTitle = data[11] || '-'; let room = data[2]; let date = data[3]; let time = `${data[4]}-${data[5]}`;
      let booker = data[6]; let managerEmail = data[13]; let desc = data[12] || '-'; let status = data[9];
      let managerApprove = managerEmail ? managerEmail.split('@')[0] : 'Approved'; 
      let printDate = new Date().toLocaleDateString('th-TH');

      // üü¢ ‡∏ô‡∏≥‡∏•‡∏≤‡∏¢‡πÄ‡∏ã‡πá‡∏ô‡∏à‡∏≤‡∏Å‡∏£‡∏∞‡∏ö‡∏ö‡∏°‡∏≤‡πÉ‡∏ä‡πâ‡∏á‡∏≤‡∏ô (‡∏î‡∏∂‡∏á‡∏à‡∏≤‡∏Å‡∏ï‡∏±‡∏ß‡πÅ‡∏õ‡∏£ globalSignatures ‡∏ó‡∏µ‡πà‡πÄ‡∏£‡∏≤‡∏î‡∏∂‡∏á‡∏°‡∏≤‡∏à‡∏≤‡∏Å‡∏´‡∏•‡∏±‡∏á‡∏ö‡πâ‡∏≤‡∏ô)
      let defaultSign = "https://cdn-icons-png.flaticon.com/512/3771/3771278.png";
      let signBooker = globalSignatures[booker] || defaultSign;
      let signManager = globalSignatures[managerEmail] || defaultSign;
      let signHR = globalSignatures["HR_ADMIN"] || defaultSign;
      
      let companyLogo = "https://lh3.googleusercontent.com/d/1XreUiNnpIFxs_qraizBUdSq3RxbpeZRd"; // ‡πÄ‡∏õ‡∏•‡∏µ‡πà‡∏¢‡∏ô‡∏•‡∏¥‡∏á‡∏Å‡πå‡πÇ‡∏•‡πÇ‡∏Å‡πâ‡∏à‡∏£‡∏¥‡∏á‡∏ó‡∏µ‡πà‡∏ô‡∏µ‡πà
      
      let pdfHtml = `
        <div id="pdf-content" style="padding: 40px; font-family: sans-serif; background: white; width: 800px; color: black; position: relative;">
          
          <div style="border-bottom: 2px solid #0056b3; padding-bottom: 15px; margin-bottom: 20px; display: flex; justify-content: space-between; align-items: flex-end;">
            <div style="display: flex; align-items: center;">
              <img src="${companyLogo}" crossorigin="anonymous" style="width: 70px; height: 70px; margin-right: 15px; object-fit: contain;">
              <div>
                <h2 style="color: #0056b3; margin: 0; font-size: 22px;">Thai Nippon Rubber Industry Public Company Limited</h2>
                <h4 style="color: #555; margin: 5px 0 0 0; font-size: 16px;">‡πÅ‡∏ö‡∏ö‡∏ü‡∏≠‡∏£‡πå‡∏°‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô‡∏Å‡∏≤‡∏£‡∏à‡∏≠‡∏á‡∏´‡πâ‡∏≠‡∏á‡∏õ‡∏£‡∏∞‡∏ä‡∏∏‡∏° (Meeting Room Booking)</h4>
              </div>
            </div>
            <div style="text-align: right; font-size: 12px; color: #666; white-space: nowrap;">
              <p style="margin: 0;"><b>‡πÄ‡∏•‡∏Ç‡∏ó‡∏µ‡πà‡∏≠‡πâ‡∏≤‡∏á‡∏≠‡∏¥‡∏á:</b> ${bookingId}</p>
              <p style="margin: 0;"><b>‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà‡∏û‡∏¥‡∏°‡∏û‡πå:</b> ${printDate}</p>
            </div>
          </div>

          <table style="width: 100%; border-collapse: collapse; margin-bottom: 20px; font-size: 14px;">
            <tr><td style="padding: 8px; width: 30%; border: 1px solid #ddd; background: #f9f9f9;"><b>‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞‡∏Å‡∏≤‡∏£‡∏à‡∏≠‡∏á:</b></td><td style="padding: 8px; border: 1px solid #ddd;"><span style="color: green; font-weight: bold;">[ ${status.toUpperCase()} ] - ‡πÑ‡∏î‡πâ‡∏£‡∏±‡∏ö‡∏Å‡∏≤‡∏£‡∏≠‡∏ô‡∏∏‡∏°‡∏±‡∏ï‡∏¥‡πÅ‡∏•‡πâ‡∏ß</span></td></tr>
            <tr><td style="padding: 8px; border: 1px solid #ddd; background: #f9f9f9;"><b>‡∏ú‡∏π‡πâ‡∏Ç‡∏≠‡∏à‡∏≠‡∏á:</b></td><td style="padding: 8px; border: 1px solid #ddd;">${booker}</td></tr>
            <tr><td style="padding: 8px; border: 1px solid #ddd; background: #f9f9f9;"><b>‡∏´‡∏±‡∏ß‡∏Ç‡πâ‡∏≠‡∏Å‡∏≤‡∏£‡∏õ‡∏£‡∏∞‡∏ä‡∏∏‡∏°:</b></td><td style="padding: 8px; border: 1px solid #ddd;">${safeTitle}</td></tr>
            <tr><td style="padding: 8px; border: 1px solid #ddd; background: #f9f9f9;"><b>‡∏´‡πâ‡∏≠‡∏á‡∏õ‡∏£‡∏∞‡∏ä‡∏∏‡∏°:</b></td><td style="padding: 8px; border: 1px solid #ddd; font-weight: bold; color: #0056b3;">${room}</td></tr>
            <tr><td style="padding: 8px; border: 1px solid #ddd; background: #f9f9f9;"><b>‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà‡πÉ‡∏ä‡πâ‡∏á‡∏≤‡∏ô:</b></td><td style="padding: 8px; border: 1px solid #ddd;">${date}</td></tr>
            <tr><td style="padding: 8px; border: 1px solid #ddd; background: #f9f9f9;"><b>‡πÄ‡∏ß‡∏•‡∏≤:</b></td><td style="padding: 8px; border: 1px solid #ddd;">${time}</td></tr>
          </table>

          <div style="border: 1px solid #ddd; padding: 15px; background: #fdfdfd; min-height: 100px;">
            <p style="margin-top: 0; font-weight: bold; border-bottom: 1px solid #ccc; padding-bottom: 5px;">‡∏£‡∏≤‡∏¢‡∏•‡∏∞‡πÄ‡∏≠‡∏µ‡∏¢‡∏î / ‡∏≠‡∏∏‡∏õ‡∏Å‡∏£‡∏ì‡πå‡πÄ‡∏û‡∏¥‡πà‡∏°‡πÄ‡∏ï‡∏¥‡∏°:</p>
            <div style="white-space: pre-wrap; font-size: 13px; line-height: 1.6;">${desc}</div>
          </div>

          <div style="margin-top: 60px; display: flex; justify-content: space-around; text-align: center; font-size: 13px;">
            <div>
              <img src="${signBooker}" crossorigin="anonymous" style="height: 40px; margin-bottom: -10px; max-width: 150px; object-fit: contain;" alt="Sign Booker">
              <p style="margin: 0;">__________________________</p>
              <p style="margin-top: 5px;">‡∏ú‡∏π‡πâ‡∏Ç‡∏≠‡∏à‡∏≠‡∏á<br>(${booker})</p>
            </div>
            <div>
              <img src="${signManager}" crossorigin="anonymous" style="height: 40px; margin-bottom: -10px; max-width: 150px; object-fit: contain;" alt="Sign Manager">
              <p style="margin: 0;">__________________________</p>
              <p style="margin-top: 5px;">‡∏ú‡∏π‡πâ‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£‡πÅ‡∏ú‡∏ô‡∏Å (‡∏ú‡∏π‡πâ‡∏≠‡∏ô‡∏∏‡∏°‡∏±‡∏ï‡∏¥‡∏Ç‡∏±‡πâ‡∏ô‡∏ï‡πâ‡∏ô)<br>(${managerApprove})</p>
            </div>
            <div>
              <img src="${signHR}" crossorigin="anonymous" style="height: 40px; margin-bottom: -10px; max-width: 150px; object-fit: contain;" alt="Sign HR">
              <p style="margin: 0;">__________________________</p>
              <p style="margin-top: 5px;">‡∏ù‡πà‡∏≤‡∏¢‡∏ö‡∏∏‡∏Ñ‡∏Ñ‡∏•/‡∏™‡πà‡∏ß‡∏ô‡∏Å‡∏•‡∏≤‡∏á<br>(‡∏ú‡∏π‡πâ‡∏≠‡∏ô‡∏∏‡∏°‡∏±‡∏ï‡∏¥‡πÄ‡∏≠‡∏Å‡∏™‡∏≤‡∏£)</p>
            </div>
          </div>

          <div style="margin-top: 60px; font-size: 11px; color: #777; border-top: 1px solid #eee; padding-top: 10px; text-align: left;">
            <b>Form No.</b> PER-48 &nbsp;&nbsp;&nbsp; <b>Issue No.</b> 02 &nbsp;&nbsp;&nbsp; <b>Effective Date:</b> 02/10/2023
          </div>
          
        </div>
      `;

      const container = document.createElement('div');
      container.innerHTML = pdfHtml;
      container.style.position = 'absolute';
      container.style.left = '-9999px';
      document.body.appendChild(container);

      html2canvas(document.getElementById('pdf-content'), { scale: 2, useCORS: true }).then(canvas => {
        const imgData = canvas.toDataURL('image/jpeg');
        const pdf = new jspdf.jsPDF({ orientation: 'p', unit: 'mm', format: 'a4' });
        const imgProps = pdf.getImageProperties(imgData);
        const pdfWidth = pdf.internal.pageSize.getWidth();
        const pdfHeight = (imgProps.height * pdfWidth) / imgProps.width;
        
        pdf.addImage(imgData, 'JPEG', 0, 0, pdfWidth, pdfHeight);
        pdf.save(`TNR_Booking_${bookingId}.pdf`);
        
        document.body.removeChild(container);
        Swal.close();
      });
    }

    $('#bookingForm').on('submit', function(e) {
      e.preventDefault(); const btn = $('#submitBookingBtn'); btn.prop('disabled',true).text('‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏™‡πà‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•...');
      const u = JSON.parse(sessionStorage.getItem("activeUser")); const f = $('#bookFile')[0].files[0];
      let equips = []; $('input[name="bookEquip"]:checked').each(function() { equips.push($(this).val()); });

      let combinedDesc = `‡πÅ‡∏ú‡∏ô‡∏Å: ${$('#bookDept').val()} | ‡πÇ‡∏ó‡∏£: ${$('#bookPhone').val()}
‡∏õ‡∏£‡∏∞‡πÄ‡∏†‡∏ó‡∏Å‡∏¥‡∏à‡∏Å‡∏£‡∏£‡∏°: ${$('#bookActivityType').val()} | ‡∏à‡∏≥‡∏ô‡∏ß‡∏ô: ${$('#bookHeadcount').val()} ‡∏ó‡πà‡∏≤‡∏ô
‡∏≠‡∏∏‡∏õ‡∏Å‡∏£‡∏ì‡πå: ${equips.length > 0 ? equips.join(', ') : '-'}
‡∏£‡∏≤‡∏¢‡∏•‡∏∞‡πÄ‡∏≠‡∏µ‡∏¢‡∏î: ${$('#bookDesc').val()}`;

      const d = { 
        username: u.username, name: u.name, room: $('#bookRoom').val(), startDate: $('#bookStartDate').val(), endDate: $('#bookEndDate').val(), 
        startTime: $('#bookStartTime').val(), endTime: $('#bookEndTime').val(), attendees: $('#bookAttendees').val(), title: $('#bookTitle').val(), 
        description: combinedDesc, managerEmail: $('#bookManagerEmail').val(), fileBase64: "", fileName: "" 
      };

      if(f) { const r = new FileReader(); r.onload = e => { d.fileBase64 = e.target.result; d.fileName = f.name; google.script.run.withSuccessHandler(res => { btn.prop('disabled',false).text('‡∏™‡πà‡∏á‡∏Ñ‡∏≥‡∏Ç‡∏≠‡∏à‡∏≠‡∏á‡∏´‡πâ‡∏≠‡∏á'); if(res.success) { Swal.fire('‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à',res.message,'success'); $('#bookingForm')[0].reset(); loadTableData(); if(calendar) calendar.refetchEvents(); } else Swal.fire('Error', res.message, 'error'); }).submitBooking(d); }; r.readAsDataURL(f); }
      else google.script.run.withSuccessHandler(res => { btn.prop('disabled',false).text('‡∏™‡πà‡∏á‡∏Ñ‡∏≥‡∏Ç‡∏≠‡∏à‡∏≠‡∏á‡∏´‡πâ‡∏≠‡∏á'); if(res.success) { Swal.fire('‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à',res.message,'success'); $('#bookingForm')[0].reset(); loadTableData(); if(calendar) calendar.refetchEvents(); } else Swal.fire('Error', res.message, 'error'); }).submitBooking(d);
    });

    // üü¢ ‡∏ï‡∏≤‡∏£‡∏≤‡∏á‡∏£‡∏≠‡∏≠‡∏ô‡∏∏‡∏°‡∏±‡∏ï‡∏¥‡∏™‡πà‡∏ß‡∏ô‡∏ï‡∏±‡∏ß (Dashboard) - ‡∏•‡πá‡∏≠‡∏Ñ‡∏õ‡∏∏‡πà‡∏° HR ‡∏ñ‡πâ‡∏≤‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏ñ‡∏∂‡∏á‡∏Ñ‡∏¥‡∏ß
    function loadApproval(role, username) { 
      google.script.run.withSuccessHandler(data => { 
        let h = ""; 
        data.forEach(r => { 
          let safeDate = r[3]; let safeTime = `${r[4]}-${r[5]}`;
          let encTitle = encodeURIComponent(r[11] || '-'); let encBooker = encodeURIComponent(r[6] || '-'); let encRoom = encodeURIComponent(r[2] || '-'); let encDesc = encodeURIComponent(r[12] || '-');
          
          let btnApprove = `<button class="btn btn-sm btn-success rounded-pill me-1 mb-1" onclick="appr('${r[0]}','Approve','${encTitle}','${safeDate}','${safeTime}','${encBooker}','${encRoom}','${encDesc}')"><i class="fa-solid fa-check"></i></button>`;
          let btnReject = `<button class="btn btn-sm btn-danger rounded-pill mb-1" onclick="appr('${r[0]}','Reject','${encTitle}','${safeDate}','${safeTime}','${encBooker}','${encRoom}','${encDesc}')"><i class="fa-solid fa-xmark"></i></button>`;

          // üî¥ ‡∏ñ‡πâ‡∏≤‡πÄ‡∏õ‡πá‡∏ô HR ‡πÅ‡∏ï‡πà‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞‡∏¢‡∏±‡∏á‡∏£‡∏≠‡πÅ‡∏ú‡∏ô‡∏Å ‡πÉ‡∏´‡πâ‡πÄ‡∏õ‡∏•‡∏µ‡πà‡∏¢‡∏ô‡∏õ‡∏∏‡πà‡∏°‡πÄ‡∏õ‡πá‡∏ô‡∏™‡∏µ‡πÄ‡∏ó‡∏≤ ‡∏Å‡∏î‡πÑ‡∏°‡πà‡πÑ‡∏î‡πâ
          if (role === 'HRManager' && r[9] === 'Pending_Dept') {
            btnApprove = `<button class="btn btn-sm btn-secondary rounded-pill me-1 mb-1" disabled title="‡∏£‡∏≠‡∏´‡∏±‡∏ß‡∏´‡∏ô‡πâ‡∏≤‡πÅ‡∏ú‡∏ô‡∏Å‡∏≠‡∏ô‡∏∏‡∏°‡∏±‡∏ï‡∏¥‡∏Å‡πà‡∏≠‡∏ô"><i class="fa-solid fa-clock"></i> ‡∏£‡∏≠‡πÅ‡∏ú‡∏ô‡∏Å</button>`;
            btnReject = `<button class="btn btn-sm btn-secondary rounded-pill mb-1" disabled><i class="fa-solid fa-xmark"></i></button>`;
          }

          h += `<tr><td>${safeDate}</td><td>${safeTime}</td><td>${r[2]}</td><td>${r[6]}</td><td>
            ${btnApprove}
            ${btnReject}
          </td></tr>`; 
        }); 
        $('#approvalSection').toggle(data.length > 0); $('#approvalBody').html(h); 
      }).getPendingApprovals(role, username); 
    }

    function loadAdminAppTable() { 
      const u = JSON.parse(sessionStorage.getItem("activeUser"));
      google.script.run.withSuccessHandler(data => { 
        const rows = data.map(r => {
          let safeDate = r[3]; let safeTime = `${r[4]}-${r[5]}`;
          let encTitle = encodeURIComponent(r[11] || '-'); let encBooker = encodeURIComponent(r[6] || '-'); let encRoom = encodeURIComponent(r[2] || '-'); let encDesc = encodeURIComponent(r[12] || '-');
          return [safeDate, safeTime, r[2], r[6], r[9], `<button class="btn btn-sm btn-success rounded-pill" onclick="appr('${r[0]}','Approve','${encTitle}','${safeDate}','${safeTime}','${encBooker}','${encRoom}','${encDesc}')">‡∏≠‡∏ô‡∏∏‡∏°‡∏±‡∏ï‡∏¥‡πÅ‡∏ó‡∏ô</button>`];
        }); 
        if($.fn.DataTable.isDataTable('#adminAppTable')) $('#adminAppTable').DataTable().destroy(); 
        $('#adminAppTable').DataTable({data:rows}); 
      }).getPendingApprovals('Admin', u.username); 
    }

    function appr(id, act, encTitle, date, time, encBooker, encRoom, encDesc) { 
      const u = JSON.parse(sessionStorage.getItem("activeUser"));
      let title = decodeURIComponent(encTitle); let booker = decodeURIComponent(encBooker); let room = decodeURIComponent(encRoom); let desc = decodeURIComponent(encDesc);
      let html = `<div style="text-align:left; padding:15px; background:#f0f7ff; border-radius:15px; border-left:6px solid #0056b3; margin-bottom:15px;"><p class="mb-2 text-dark fw-bold">üìå ${title}</p><p class="mb-1 small"><b>üìÖ ‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà:</b> ${date} <b>‚è∞ ‡πÄ‡∏ß‡∏•‡∏≤:</b> ${time} ‡∏ô.</p><p class="mb-1 small"><b>üè¢ ‡∏´‡πâ‡∏≠‡∏á:</b> <span class="text-primary fw-bold">${room}</span></p><p class="mb-1 small"><b>üë§ ‡∏ú‡∏π‡πâ‡∏à‡∏≠‡∏á:</b> ${booker}</p><hr class="my-2 border-secondary"><div class="p-2 bg-white rounded shadow-sm border border-light"><p class="mb-1 text-primary fw-bold small"><i class="fa-solid fa-list-ul me-1"></i> ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÄ‡∏û‡∏¥‡πà‡∏°‡πÄ‡∏ï‡∏¥‡∏°</p><div style="white-space: pre-wrap; font-size: 0.85rem; line-height: 1.5; color: #495057;">${desc}</div></div></div><p>‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô‡∏Å‡∏≤‡∏£ <b class="${act === 'Approve' ? 'text-success' : 'text-danger'}">${act === 'Approve' ? '‡∏≠‡∏ô‡∏∏‡∏°‡∏±‡∏ï‡∏¥' : '‡∏õ‡∏è‡∏¥‡πÄ‡∏™‡∏ò'}</b> ‡∏Ñ‡∏¥‡∏ß‡∏ô‡∏µ‡πâ‡∏´‡∏£‡∏∑‡∏≠‡πÑ‡∏°‡πà?</p>`;
      Swal.fire({ title: '‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏£‡∏≤‡∏¢‡∏•‡∏∞‡πÄ‡∏≠‡∏µ‡∏¢‡∏î', html: html, icon: 'info', showCancelButton: true, confirmButtonText: '‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô', cancelButtonText: '‡∏¢‡∏Å‡πÄ‡∏•‡∏¥‡∏Å', confirmButtonColor: act === 'Approve' ? '#28a745' : '#d33' }).then(res => {
        if(res.isConfirmed) { Swal.fire({ title: '‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å...', allowOutsideClick: false, didOpen: () => Swal.showLoading() }); google.script.run.withSuccessHandler(r => { if(r.success){ Swal.fire('‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à', r.message, 'success'); } else { Swal.fire('‡∏Ñ‡∏≥‡πÄ‡∏ï‡∏∑‡∏≠‡∏ô', r.message, 'error'); } loadTableData(); if(calendar) calendar.refetchEvents(); if(u.role === 'Admin') loadAdminAppTable(); }).processApproval(id, act, u.role, u.username); }
      });
    }

    // üü¢ 3. ‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï‡∏ï‡∏≤‡∏£‡∏≤‡∏á‡πÅ‡∏•‡∏∞‡∏õ‡∏∏‡πà‡∏°‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç‡∏ú‡∏π‡πâ‡πÉ‡∏ä‡πâ ‡πÉ‡∏´‡πâ‡∏£‡∏±‡∏ö‡∏™‡πà‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏• "‡∏•‡∏≤‡∏¢‡πÄ‡∏ã‡πá‡∏ô"
    function loadUserTable() { 
      google.script.run.withSuccessHandler(data => { 
        const rows = data.map(r => {
          // r[5] ‡∏Ñ‡∏∑‡∏≠‡∏ä‡πà‡∏≠‡∏á‡πÄ‡∏Å‡πá‡∏ö‡∏•‡∏¥‡∏á‡∏Å‡πå‡∏£‡∏π‡∏õ‡∏•‡∏≤‡∏¢‡πÄ‡∏ã‡πá‡∏ô (‡∏Ñ‡∏≠‡∏•‡∏±‡∏°‡∏ô‡πå F ‡πÉ‡∏ô Sheet)
          let sigUrl = r[5] || '';
          let btnEdit = `<button class="btn btn-sm btn-outline-primary me-1" onclick="openUserModal('${r[0]}','${r[1]}','${r[2]}','${r[4]}','${sigUrl}')">‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç</button>`;
          let btnDelete = r[4] === 'Admin' ? `<button class="btn btn-sm btn-outline-secondary" disabled title="‡∏´‡πâ‡∏≤‡∏°‡∏•‡∏ö Admin">‡∏•‡∏ö‡πÑ‡∏°‡πà‡πÑ‡∏î‡πâ</button>` : `<button class="btn btn-sm btn-outline-danger" onclick="delUser('${r[0]}')">‡∏•‡∏ö</button>`;
          return [r[0], r[1], r[2], r[4], btnEdit + btnDelete];
        }); 
        if($.fn.DataTable.isDataTable('#userTable')) $('#userTable').DataTable().destroy(); 
        $('#userTable').DataTable({data:rows, language: { url: '//cdn.datatables.net/plug-ins/1.13.6/i18n/th.json' }}); 
      }).adminGetUsersList('Admin'); 
    }
    
    function delUser(uid) { Swal.fire({ title: '‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô‡∏Å‡∏≤‡∏£‡∏•‡∏ö‡∏ú‡∏π‡πâ‡πÉ‡∏ä‡πâ?', text: "‡∏Å‡∏≤‡∏£‡∏Å‡∏£‡∏∞‡∏ó‡∏≥‡∏ô‡∏µ‡πâ‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡∏¢‡πâ‡∏≠‡∏ô‡∏Å‡∏•‡∏±‡∏ö‡πÑ‡∏î‡πâ!", icon: 'warning', showCancelButton: true, confirmButtonColor: '#d33' }).then(r => { if(r.isConfirmed) google.script.run.withSuccessHandler(res => { if(res.success) { Swal.fire('‡∏•‡∏ö‡πÅ‡∏•‡πâ‡∏ß!', res.message, 'success'); loadUserTable(); } else { Swal.fire('‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î', res.message, 'error'); } }).adminDeleteUser(uid, 'Admin'); }); }
    function updateTop(counts) { let sorted = Object.keys(counts).map(k=>({n:k,c:counts[k]})).sort((a,b)=>b.c-a.c).slice(0,3); let h = ""; sorted.forEach((r,i) => { h += `<div class="col-4"><div class="card p-2 shadow-sm border"><h4 class="mb-1" style="color:var(--vibrant-pink);">${['ü•á','ü•à','ü•â'][i]}</h4><b class="small">${r.n}</b><br><span class="badge bg-light border" style="color:var(--primary-blue);">${r.c} ‡∏Ñ‡∏£‡∏±‡πâ‡∏á</span></div></div>`; }); $('#statTopRooms').html(h||"‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•"); }
   function cancelB(id) { 
      Swal.fire({
        title: '‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô‡∏¢‡∏Å‡πÄ‡∏•‡∏¥‡∏Å‡∏Å‡∏≤‡∏£‡∏à‡∏≠‡∏á ‡πÉ‡∏ä‡πà‡∏´‡∏£‡∏∑‡∏≠‡πÑ‡∏°‡πà?',
        text: "‡∏´‡∏≤‡∏Å‡∏¢‡∏Å‡πÄ‡∏•‡∏¥‡∏Å‡πÅ‡∏•‡πâ‡∏ß ‡∏à‡∏∞‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡πÄ‡∏£‡∏µ‡∏¢‡∏Å‡∏Ñ‡∏∑‡∏ô‡∏Ñ‡∏¥‡∏ß‡∏ô‡∏µ‡πâ‡πÑ‡∏î‡πâ",
        icon: 'warning', 
        showCancelButton: true,
        confirmButtonColor: '#d33',
        cancelButtonColor: '#6c757d',
        confirmButtonText: '‡πÉ‡∏ä‡πà, ‡∏¢‡∏Å‡πÄ‡∏•‡∏¥‡∏Å‡∏Å‡∏≤‡∏£‡∏à‡∏≠‡∏á',
        cancelButtonText: '‡∏õ‡∏¥‡∏î'
      }).then((result) => { 
        if(result.isConfirmed) {
          Swal.fire({ title: '‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏¢‡∏Å‡πÄ‡∏•‡∏¥‡∏Å...', didOpen: () => Swal.showLoading() });
          google.script.run.withSuccessHandler((res) => {
            if(res.success) {
              Swal.fire('‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à', res.message, 'success');
              loadTableData(); 
              if(calendar) calendar.refetchEvents(); 
            } else {
              Swal.fire('‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î', res.message, 'error');
            }
          }).cancelBooking(id, JSON.parse(sessionStorage.getItem("activeUser")).name); 
        }
      }); 
    }
    
    // üü¢ 4. ‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏ä‡πà‡∏≠‡∏á‡∏Å‡∏£‡∏≠‡∏Å URL ‡∏•‡∏≤‡∏¢‡πÄ‡∏ã‡πá‡∏ô‡∏•‡∏á‡πÉ‡∏ô Popup ‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£‡∏ú‡∏π‡πâ‡πÉ‡∏ä‡πâ
    function openUserModal(uid='', name='', user='', role='User', signature='') { 
      Swal.fire({ 
        title: 'USER INFO & SIGNATURE', 
        html: `
          <input id="u_name" class="form-control mb-3" placeholder="‡∏ä‡∏∑‡πà‡∏≠" value="${name}">
          <input id="u_user" class="form-control mb-3" placeholder="‡∏≠‡∏µ‡πÄ‡∏°‡∏• (Username)" value="${user}">
          <input id="u_pass" type="password" class="form-control mb-3" placeholder="Password (‡∏õ‡∏•‡πà‡∏≠‡∏¢‡∏ß‡πà‡∏≤‡∏á‡∏ñ‡πâ‡∏≤‡πÑ‡∏°‡πà‡πÄ‡∏õ‡∏•‡∏µ‡πà‡∏¢‡∏ô)">
          <input id="u_sign" class="form-control mb-3 border-info" placeholder="‡∏ß‡∏≤‡∏á‡∏•‡∏¥‡∏á‡∏Å‡πå‡∏£‡∏π‡∏õ‡∏•‡∏≤‡∏¢‡πÄ‡∏ã‡πá‡∏ô (URL/Base64)" value="${signature}">
          <select id="u_role" class="form-select">
            <option value="User" ${role==='User'?'selected':''}>User</option>
            <option value="DeptManager" ${role==='DeptManager'?'selected':''}>DeptManager</option>
            <option value="HRManager" ${role==='HRManager'?'selected':''}>HRManager</option>
            <option value="Admin" ${role==='Admin'?'selected':''}>Admin</option>
          </select>
        `, 
        showCancelButton: true, 
        preConfirm: () => ({
          uid:uid, name:$('#u_name').val(), username:$('#u_user').val(), 
          password:$('#u_pass').val(), role:$('#u_role').val(), signature:$('#u_sign').val() // ‡∏™‡πà‡∏á‡∏•‡∏≤‡∏¢‡πÄ‡∏ã‡πá‡∏ô‡πÑ‡∏õ‡πÉ‡∏´‡πâ‡∏´‡∏•‡∏±‡∏á‡∏ö‡πâ‡∏≤‡∏ô
        }) 
      }).then(res => { 
        if(res.isConfirmed) {
          google.script.run.withSuccessHandler(r => { 
            loadUserTable(); 
            fetchSignatures(); // ‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï‡∏•‡∏≤‡∏¢‡πÄ‡∏ã‡πá‡∏ô‡πÄ‡∏Ç‡πâ‡∏≤‡∏£‡∏∞‡∏ö‡∏ö‡∏ó‡∏±‡∏ô‡∏ó‡∏µ
          }).adminSaveUser(res.value, 'Admin'); 
        }
      }); 
    }
  </script>
</body>
</html>
